name: Secret Detection

# This workflow scans for secrets and sensitive data in commits
# It helps prevent accidental exposure of credentials and API keys

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - master

jobs:
  detect-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Install secret detection tools
        run: |
          pip install detect-secrets
          
      - name: Run secret detection scan
        run: |
          echo "Scanning repository for secrets..."
          
          # Create initial baseline if it doesn't exist
          if [ ! -f .secrets.baseline ]; then
            echo "Creating initial baseline..."
            detect-secrets scan --all-files > .secrets.baseline
            echo "Created new baseline file"
          else
            # Scan for new secrets
            echo "Scanning for secrets against baseline..."
            detect-secrets scan --baseline .secrets.baseline --all-files
            
            # Audit the results
            AUDIT_RESULTS=$(detect-secrets audit .secrets.baseline --report 2>&1 || true)
            
            echo "Scan complete"
            echo "$AUDIT_RESULTS"
            
            # Check if any secrets were found (you can make this stricter)
            if echo "$AUDIT_RESULTS" | grep -q "Total: 0"; then
              echo "✅ No secrets detected"
            else
              echo "⚠️  Potential secrets detected - please review"
              # Uncomment the line below to fail the build on detected secrets
              # exit 1
            fi
          fi
          
      - name: TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
